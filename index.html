<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Alert Monitor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { text-align: center; margin-bottom: 20px; }
        .status {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.2em;
        }
        .indicator {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #ddd;
            margin-right: 10px;
        }
        .indicator.active {
            background: #4caf50;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        button {
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
        }
        .btn-start { background: #1e3c72; color: white; }
        .btn-stop { background: #888; color: white; }
        .btn-test { background: #ff4444; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #1e3c72; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Portfolio Alert Monitor</h1>
        
        <div class="status">
            <span class="indicator" id="indicator"></span>
            <span id="status">Ready</span> | 
            Assets: <span id="count">0</span> | 
            Alerts: <span id="alerts">0</span>
        </div>
        
        <div style="text-align: center;">
            <button class="btn-start" id="startBtn">Start Monitoring</button>
            <button class="btn-stop" id="stopBtn">Stop</button>
            <button class="btn-test" id="testBtn">TEST ALERT</button>
        </div>
        
        <table id="table" style="display:none;">
            <thead>
                <tr>
                    <th>Asset</th>
                    <th>Current Price</th>
                    <th>Low Alert</th>
                    <th>High Alert</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
        
        <p style="text-align:center; margin-top:20px; color:#888;" id="lastCheck">Last checked: Never</p>
    </div>

    <script>
        var API_TOKEN = 'cd5b1a01-8720-47c4-b0e7-fdf38a6f7d67';
        var DOC_ID = 'hZ3P_5oLA4';
        var TABLE_NAME = 'Portfolio Snapshot';
        var HIGH_ALERT_COL = '\uD83D\uDEA8 High Alert';
        var LOW_ALERT_COL = '\u26A0\uFE0F Low Alert';
        
        var interval = null;
        var dismissed = {};
        var audioContext = null;
        var mainOscillator = null;
        var mainGain = null;
        
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('Audio initialized!');
            }
        }
        
        function playAlarm() {
            if (!audioContext) {
                console.log('Audio not initialized');
                return;
            }
            
            stopAlarm();
            
            mainOscillator = audioContext.createOscillator();
            mainGain = audioContext.createGain();
            
            mainOscillator.connect(mainGain);
            mainGain.connect(audioContext.destination);
            mainOscillator.frequency.value = 800;
            mainOscillator.type = 'sine';
            mainGain.gain.value = 0.4;
            mainOscillator.start();
            
            var toggle = true;
            window.alarmInterval = setInterval(function() {
                if (mainOscillator) {
                    mainOscillator.frequency.value = toggle ? 800 : 1000;
                    toggle = !toggle;
                }
            }, 300);
            
            console.log('ALARM PLAYING!');
        }
        
        function stopAlarm() {
            if (window.alarmInterval) {
                clearInterval(window.alarmInterval);
                window.alarmInterval = null;
            }
            if (mainOscillator) {
                try {
                    mainOscillator.stop();
                } catch (e) {}
                mainOscillator = null;
            }
        }
        
        document.getElementById('startBtn').onclick = function() {
            console.log('Start clicked - initializing audio');
            initAudio();
            document.getElementById('indicator').classList.add('active');
            document.getElementById('status').textContent = 'Monitoring... (Audio Ready)';
            checkPrices();
            interval = setInterval(checkPrices, 30000);
        };
        
        document.getElementById('stopBtn').onclick = function() {
            console.log('Stop clicked');
            if (interval) clearInterval(interval);
            stopAlarm();
            document.getElementById('indicator').classList.remove('active');
            document.getElementById('status').textContent = 'Stopped';
        };
        
        document.getElementById('testBtn').onclick = function() {
            console.log('Test clicked');
            initAudio();
            playAlarm();
            openAlertWindow([{
                asset: 'Test Bitcoin',
                currentPrice: 96500,
                threshold: 95000,
                type: 'HIGH'
            }]);
        };
        
        function checkPrices() {
            console.log('Checking prices...');
            var url = 'https://coda.io/apis/v1/docs/' + DOC_ID + '/tables/' + encodeURIComponent(TABLE_NAME) + '/rows?useColumnNames=true';
            
            fetch(url, {
                headers: { 'Authorization': 'Bearer ' + API_TOKEN }
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                var rows = data.items || [];
                console.log('Got ' + rows.length + ' rows');
                
                var triggered = [];
                var html = '';
                
                for (var i = 0; i < rows.length; i++) {
                    var values = rows[i].values;
                    var asset = values['Asset Name (ticker)'] || 'Unknown';
                    var currentStr = String(values['Current Price'] || '0');
                    var highStr = String(values[HIGH_ALERT_COL] || '0');
                    var lowStr = String(values[LOW_ALERT_COL] || '0');
                    
                    var current = parseFloat(currentStr.replace(/[$,]/g, ''));
                    var high = parseFloat(highStr.replace(/[$,]/g, ''));
                    var low = parseFloat(lowStr.replace(/[$,]/g, ''));
                    
                    var status = 'OK';
                    var alertKey = null;
                    
                    if (high > 0 && current >= high) {
                        status = 'HIGH';
                        alertKey = asset + '-HIGH';
                        if (!dismissed[alertKey]) {
                            triggered.push({
                                asset: asset,
                                currentPrice: current,
                                threshold: high,
                                type: 'HIGH'
                            });
                        }
                    } else if (low > 0 && current <= low) {
                        status = 'LOW';
                        alertKey = asset + '-LOW';
                        if (!dismissed[alertKey]) {
                            triggered.push({
                                asset: asset,
                                currentPrice: current,
                                threshold: low,
                                type: 'LOW'
                            });
                        }
                    } else {
                        delete dismissed[asset + '-HIGH'];
                        delete dismissed[asset + '-LOW'];
                    }
                    
                    html += '<tr>';
                    html += '<td>' + asset + '</td>';
                    html += '<td>$' + current.toFixed(2) + '</td>';
                    html += '<td>$' + low.toFixed(2) + '</td>';
                    html += '<td>$' + high.toFixed(2) + '</td>';
                    html += '<td>' + status + '</td>';
                    html += '</tr>';
                }
                
                document.getElementById('tbody').innerHTML = html;
                document.getElementById('table').style.display = 'table';
                document.getElementById('count').textContent = rows.length;
                document.getElementById('alerts').textContent = triggered.length;
                document.getElementById('lastCheck').textContent = 'Last checked: ' + new Date().toLocaleTimeString();
                
                if (triggered.length > 0) {
                    console.log(triggered.length + ' alerts triggered - PLAYING ALARM');
                    playAlarm();
                    openAlertWindow(triggered);
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                document.getElementById('status').textContent = 'Error: ' + error.message;
            });
        }
        
        function openAlertWindow(assets) {
            var popup = window.open('', 'AlertWindow', 'width=700,height=500');
            if (!popup) {
                alert('Pop-up blocked! Please allow pop-ups for this site.');
                return;
            }
            
            var popupHTML = '<!DOCTYPE html>';
            popupHTML += '<html><head><meta charset="UTF-8"><title>ALERT</title>';
            popupHTML += '<style>';
            popupHTML += 'body{background:#f00;color:#fff;font-family:Arial;display:flex;align-items:center;justify-content:center;min-height:100vh;animation:flash 0.5s infinite}';
            popupHTML += '@keyframes flash{0%,100%{background:#f00}50%{background:#c00}}';
            popupHTML += '.box{text-align:center;padding:40px;background:rgba(0,0,0,0.3);border-radius:20px}';
            popupHTML += 'h1{font-size:3em;margin-bottom:20px}';
            popupHTML += '.item{background:#fff;color:#333;padding:15px;border-radius:10px;margin:10px 0}';
            popupHTML += 'button{background:#fc0;color:#333;border:none;padding:15px 30px;font-size:1.2em;border-radius:10px;cursor:pointer;margin-top:20px}';
            popupHTML += '</style></head><body>';
            popupHTML += '<div class="box"><h1>ALERT!</h1>';
            
            for (var i = 0; i < assets.length; i++) {
                var a = assets[i];
                popupHTML += '<div class="item">';
                popupHTML += '<strong>' + a.asset + '</strong><br>';
                popupHTML += a.type + ' ALERT<br>';
                popupHTML += 'Current: $' + a.currentPrice.toFixed(2);
                popupHTML += ' | Threshold: $' + a.threshold.toFixed(2);
                popupHTML += '</div>';
            }
            
            popupHTML += '<button onclick="dismissAlert()">DISMISS</button></div>';
            popupHTML += '<script>';
            popupHTML += 'var ctx=new (window.AudioContext||window.webkitAudioContext)();';
            popupHTML += 'var osc=ctx.createOscillator();';
            popupHTML += 'var gain=ctx.createGain();';
            popupHTML += 'osc.connect(gain);';
            popupHTML += 'gain.connect(ctx.destination);';
            popupHTML += 'osc.frequency.value=800;';
            popupHTML += 'gain.gain.value=0.4;';
            popupHTML += 'osc.start();';
            popupHTML += 'var t=true;';
            popupHTML += 'setInterval(function(){osc.frequency.value=t?800:1000;t=!t},300);';
            popupHTML += 'function dismissAlert(){';
            popupHTML += 'if(window.opener&&!window.opener.closed){';
            popupHTML += 'window.opener.postMessage("dismiss","*");';
            popupHTML += '}';
            popupHTML += 'window.close();';
            popupHTML += '}';
            popupHTML += '<\/script></body></html>';
            
            popup.document.write(popupHTML);
            popup.document.close();
        }
        
        window.addEventListener('message', function(event) {
            if (event.data === 'dismiss') {
                stopAlarm();
            }
        });
    </script>
</body>
</html>
