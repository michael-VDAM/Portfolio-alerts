<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Portfolio Alert Monitor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { text-align: center; margin-bottom: 20px; }
        .status {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.2em;
        }
        .indicator {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #ddd;
            margin-right: 10px;
        }
        .indicator.active {
            background: #4caf50;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        button {
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
        }
        .btn-start { background: #1e3c72; color: white; }
        .btn-stop { background: #888; color: white; }
        .btn-test { background: #ff4444; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #1e3c72; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® Portfolio Alert Monitor</h1>
        
        <div class="status">
            <span class="indicator" id="indicator"></span>
            <span id="status">Ready</span> | 
            Assets: <span id="count">0</span> | 
            Alerts: <span id="alerts">0</span>
        </div>
        
        <div style="text-align: center;">
            <button class="btn-start" id="startBtn">‚ñ∂ Start Monitoring</button>
            <button class="btn-stop" id="stopBtn">‚èπ Stop</button>
            <button class="btn-test" id="testBtn">üö® TEST ALERT</button>
        </div>
        
        <table id="table" style="display:none;">
            <thead>
                <tr>
                    <th>Asset</th>
                    <th>Current Price</th>
                    <th>‚ö†Ô∏è Low Alert</th>
                    <th>üö® High Alert</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
        
        <p style="text-align:center; margin-top:20px; color:#888;" id="lastCheck">Last checked: Never</p>
    </div>

    <script>
        const API_TOKEN = 'cd5b1a01-8720-47c4-b0e7-fdf38a6f7d67';
        const DOC_ID = 'hZ3P_5oLA4';
        const TABLE_NAME = 'Portfolio Snapshot';
        
        let interval = null;
        let dismissed = new Set();
        
        document.getElementById('startBtn').addEventListener('click', function() {
            console.log('Start clicked');
            document.getElementById('indicator').classList.add('active');
            document.getElementById('status').textContent = 'Monitoring...';
            checkPrices();
            interval = setInterval(checkPrices, 30000);
        });
        
        document.getElementById('stopBtn').addEventListener('click', function() {
            console.log('Stop clicked');
            if (interval) clearInterval(interval);
            document.getElementById('indicator').classList.remove('active');
            document.getElementById('status').textContent = 'Stopped';
        });
        
        document.getElementById('testBtn').addEventListener('click', function() {
            console.log('Test clicked');
            openAlert([{
                asset: 'Test Bitcoin (BTC)',
                currentPrice: 96500,
                threshold: 95000,
                type: 'HIGH'
            }]);
        });
        
        async function checkPrices() {
            try {
                console.log('Checking prices...');
                const url = `https://coda.io/apis/v1/docs/${DOC_ID}/tables/${encodeURIComponent(TABLE_NAME)}/rows?useColumnNames=true`;
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${API_TOKEN}` }
                });
                
                const data = await response.json();
                const rows = data.items || [];
                
                console.log(`Got ${rows.length} rows`);
                
                let triggered = [];
                let html = '';
                
                rows.forEach(row => {
                    const values = row.values;
                    const asset = values['Asset Name (ticker)'] || 'Unknown';
                    const current = parseFloat(String(values['Current Price'] || '0').replace(/[$,]/g, ''));
                    const high = parseFloat(String(values['üö® High Alert'] || '0').replace(/[$,]/g, ''));
                    const low = parseFloat(String(values['‚ö†Ô∏è Low Alert'] || '0').replace(/[$,]/g, ''));
                    
                    let status = '‚úì OK';
                    let alertKey = null;
                    
                    if (high > 0 && current >= high) {
                        status = 'üî¥ HIGH';
                        alertKey = asset + '-HIGH';
                        if (!dismissed.has(alertKey)) {
                            triggered.push({ asset, currentPrice: current, threshold: high, type: 'HIGH' });
                        }
                    } else if (low > 0 && current <= low) {
                        status = 'üü° LOW';
                        alertKey = asset + '-LOW';
                        if (!dismissed.has(alertKey)) {
                            triggered.push({ asset, currentPrice: current, threshold: low, type: 'LOW' });
                        }
                    } else {
                        dismissed.delete(asset + '-HIGH');
                        dismissed.delete(asset + '-LOW');
                    }
                    
                    html += `<tr>
                        <td>${asset}</td>
                        <td>$${current.toFixed(2)}</td>
                        <td>$${low.toFixed(2)}</td>
                        <td>$${high.toFixed(2)}</td>
                        <td>${status}</td>
                    </tr>`;
                });
                
                document.getElementById('tbody').innerHTML = html;
                document.getElementById('table').style.display = 'table';
                document.getElementById('count').textContent = rows.length;
                document.getElementById('alerts').textContent = triggered.length;
                document.getElementById('lastCheck').textContent = `Last checked: ${new Date().toLocaleTimeString()}`;
                
                if (triggered.length > 0) {
                    console.log(`${triggered.length} alerts!`);
                    openAlert(triggered);
                }
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('status').textContent = 'Error: ' + error.message;
            }
        }
        
        function openAlert(assets) {
            const win = window.open('', 'Alert', 'width=700,height=500');
            if (!win) {
                alert('‚ö†Ô∏è Pop-up blocked! Please allow pop-ups for this site.');
                return;
            }
            
            win.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>üö® ALERT!</title>
                    <style>
                        body {
                            background: #ff0000;
                            color: white;
                            font-family: Arial;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            min-height: 100vh;
                            animation: flash 0.5s infinite;
                        }
                        @keyframes flash {
                            0%, 100% { background: #ff0000; }
                            50% { background: #cc0000; }
                        }
                        .box {
                            text-align: center;
                            padding: 40px;
                            background: rgba(0,0,0,0.3);
                            border-radius: 20px;
                        }
                        h1 { font-size: 3em; margin-bottom: 20px; }
                        .item {
                            background: white;
                            color: #333;
                            padding: 15px;
                            border-radius: 10px;
                            margin: 10px 0;
                        }
                        button {
                            background: #ffcc00;
                            color: #333;
                            border: none;
                            padding: 15px 30px;
                            font-size: 1.2em;
                            border-radius: 10px;
                            cursor: pointer;
                            margin-top: 20px;
                        }
                    </style>
                </head>
                <body>
                    <div class="box">
                        <h1>üö® ALERT! üö®</h1>
                        ${assets.map(a => `
                            <div class="item">
                                <strong>${a.asset}</strong><br>
                                ${a.type} ALERT<br>
                                Current: $${a.currentPrice.toFixed(2)} | Threshold: $${a.threshold.toFixed(2)}
                            </div>
                        `).join('')}
                        <button onclick="window.close()">DISMISS</button>
                    </div>
                    <script>
                        const audio = new AudioContext();
                        const osc = audio.createOscillator();
                        const gain = audio.createGain();
                        osc.connect(gain);
                        gain.connect(audio.destination);
                        osc.frequency.value = 800;
                        gain.gain.value = 0.3;
                        osc.start();
                        let toggle = true;
                        setInterval(() => {
                            osc.frequency.value = toggle ? 800 : 1000;
                            toggle = !toggle;
                        }, 300);
                    </script>
                </body>
                </html>
            `);
        }
    </script>
</body>
</html>
